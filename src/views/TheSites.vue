<template>
  <div id="app-sites">
    <CityPopupAdd
      :popupHidden="popupHidden"
      @add-city="addCity"
      @popup-toggle="popupToggle"
    />

    <AppTopPanel header="Список городов">
      <template #nav-buttons>
        <AppButtonIcon icon="autorenew" title="Обновить города" @button-click="updateCity"/>
        <AppButtonIcon icon="add" title="Добавить города" @button-click="popupToggle"/>
      </template>
    </AppTopPanel>

    <div class="app-sites-content">
      <ListSites
        :sites="sites"
        @remove-city="removeCity"
      />
    </div>
  </div>
</template>

<script>
import { mapGetters, mapMutations } from 'vuex'
import firebase from 'firebase/app'

import AppTopPanel from '@/components/AppTopPanel'
import AppButtonIcon from '@/components/AppButtonIcon'
import ListSites from '@/components/sites/list/SitesList'
import CityPopupAdd from '@/components/sites/CityPopupAdd'

export default {
  name: 'Sites',

  components: { AppTopPanel, AppButtonIcon, ListSites, CityPopupAdd },

  data () {
    return {
      popupHidden: true,
      addedCity: {
        id: Date.now(),
        name: '',
        notes: [],
        notesCount: 5
      }
    }
  },

  computed: {
    ...mapGetters([
      'sites'
    ])
  },

  created () {
    this.SET_SITES_FROM_LOCAL_STORAGE()
  },

  methods: {
    ...mapMutations([
      'SET_SITES_FROM_LOCAL_STORAGE',
      'SET_SITES_FROM_SERVER'
    ]),

    popupToggle () {
      this.popupHidden = !this.popupHidden
    },

    removeCity (id) {
      firebase.database().ref('/sites/' + id).remove()
        .then(() => {
          console.log('Город удалён 🗑️')
          this.SET_SITES_FROM_SERVER()
        })
    },

    addCity (city) {
      city.name = city.name[0].toUpperCase() + city.name.substring(1)

      firebase.database().ref('/sites/' + city.id).set(city)
        .then(() => {
          console.log('Город добавлен ➕')
          this.popupHidden = true
          this.SET_SITES_FROM_SERVER()
          this.addedCity = {
            id: Date.now(),
            name: '',
            notes: [],
            notesCount: 5
          }
        })
    },

    updateCity () {
      this.SET_SITES_FROM_SERVER()
      // eslint-disable-next-line no-undef
      M.toast({ html: 'Города обновлены' })
    }
  }
}
</script>
